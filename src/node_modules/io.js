const ports = {}
const graph = {}
let timer
module.exports = io
async function io(data, on) {
  const on_rx = {
    on: {init}
  }
  const id = data.id || Object.keys(ports).length
  ports[id] = { id, name: data.name, on}
  data.hub && graph[data.hub[0]].sub.push(id)
  graph[id] = { id, ...data, sub: [] }
  timer && clearTimeout(timer)
  timer = setTimeout(init, 1000)
  return {send, css_id: id}

  async function send(data) {
    const port = ports[data.to] || ports[await find_id(data.to)] || on_rx
    return port.on[data.type](data)
  }
  async function find_id (name){
    return (Object.values(ports).filter(node => node.name === name)[0] || {id: undefined}).id
  }
  async function init() {
    ports[await find_id('theme_widget')].on['refresh']({ data: graph})
  }
}