const ports = []
const graph = []

module.exports = io
async function io(data, on) {
  const on_rx = {
    on: {init}
  }
  const id = ports.length
  ports.push({id, name: data.name, on})
  data.hub && graph[data.hub[0]].sub.push(id)
  graph.push({ id, ...data, sub: [] })
  if(id === 33)
    init()
  return {send, css_id: id}

  async function send(data) {
    const port = ports[data.to] || ports[await find_id(data.to)] || on_rx
    return port.on[data.type](data)
  }
  async function find_id (name){
    return (ports.filter(node => node.name === name)[0] || {id: undefined}).id
  }
  async function init() {
    ports[await find_id('theme_widget')].on['refresh']({ data: graph})
  }
}